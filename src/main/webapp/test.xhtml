<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:jsf="http://xmlns.jcp.org/jsf"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>PrimeFaces Test</title>
    <h:outputScript name="popups.js"/>
    <h:outputScript name="commons.js"/>
</h:head>
<h:body>

    <h1>#{testView.string}</h1>

    <h:form>
        <p:commandButton action="#{testView.onClickButton()}"
                         value="Open calendar"
        />
        <p:remoteCommand id="remote_onAfterInitPopup"
                         name="onAfterInitPopup"
                         actionListener="#{testView.onAfterInitPopup()}"/>


        <h:outputScript name="js/tinymce/tinymce.min.js" />
        <h:outputScript name="js/upload-image.js" target="head"/>
        <h:outputScript name="js/tinymce/tinymce-images.js" target="head"/>
        <h:outputScript name="js/tinymce/tinymce-configuration.js" target="head"/>
        <script type="text/javascript">

            const options = {
                language: 'pl',
                min_height: 100,
            };

            var isPopupView = true;
            const setupFunc = function (editor) {
                editor.on('init', function () {
                    $(editor.getBody()).on('click', 'a[href]', function (ae) {
                        openLinkInNewTab($(ae.currentTarget).attr('href'));
                    });
                });



                editor.on('change', function(event) {
                    dispatchCustomEvent('change', event.target.getElement());
                });

                var eventName = isPopupView ? 'popupClose' : 'changeView';
                document.addEventListener(eventName, function (e) {
                    tinyMCE.remove('#' + editor.id.replace(/:/g, '\\:'));
                    document.removeEventListener(eventName, arguments.callee);
                });
            }

            initializeTinyMCE(options, setupFunc);
        </script>
        <p:inputTextarea

                styleClass="rich-text-editor" />
        <h:outputScript name="js/tinymce-helpers.js"/>

    </h:form>

    <h:panelGroup layout="block" id="popups-container">
        <c:forEach items="#{testView.popupsIterator}"
                   varStatus="loop">
            <h:panelGroup layout="block"
                          id="popup-#{loop.index}"
                          styleClass="ui-popup">
                <ui:insert name="popup-#{loop.index}">
                    <ui:include
                            src="#{testView.popupContent[loop.index]}">
                        <ui:param name="popup"
                                  value="#{loop.index + 1}"/>
                    </ui:include>
                </ui:insert>
            </h:panelGroup>
            <h:panelGroup layout="block"
                          id="popup-#{loop.index}-overlay"
                          styleClass="ui-popup-overlay">
            </h:panelGroup>
        </c:forEach>
    </h:panelGroup>
</h:body>
</html>
